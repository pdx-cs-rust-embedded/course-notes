<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MicroBit 2 (MB2) Setup - Embedded Rust Course Notes</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Embedded Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../prelude/prereqs.html"><strong aria-hidden="true">1.1.</strong> What You Need</a></li><li class="chapter-item expanded "><a href="../prelude/about-embedded.html"><strong aria-hidden="true">1.2.</strong> About Embedded Systems</a></li></ol></li><li class="chapter-item expanded "><a href="../starting/index.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../starting/mb2-setup.html" class="active"><strong aria-hidden="true">2.1.</strong> MicroBit 2 (MB2) Setup</a></li><li class="chapter-item expanded "><a href="../starting/rust-review.html"><strong aria-hidden="true">2.2.</strong> Rust Review / Refresher</a></li><li class="chapter-item expanded "><a href="../starting/embedded.html"><strong aria-hidden="true">2.3.</strong> Embedded Programming</a></li><li class="chapter-item expanded "><a href="../starting/blinky.html"><strong aria-hidden="true">2.4.</strong> Blinky: A First Embedded Program</a></li></ol></li><li class="chapter-item expanded "><a href="../hardware/index.html"><strong aria-hidden="true">3.</strong> Understanding Hardware</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../hardware/electricity.html"><strong aria-hidden="true">3.1.</strong> Basic Electricity</a></li><li class="chapter-item expanded "><a href="../hardware/soc.html"><strong aria-hidden="true">3.2.</strong> System-On-Chip (SoC) Hardware</a></li><li class="chapter-item expanded "><a href="../hardware/manual-reading.html"><strong aria-hidden="true">3.3.</strong> Reading SoC and Device Manuals</a></li><li class="chapter-item expanded "><a href="../hardware/debugging.html"><strong aria-hidden="true">3.4.</strong> Embedded Debugging</a></li></ol></li><li class="chapter-item expanded "><a href="../peripherals/index.html"><strong aria-hidden="true">4.</strong> Working With Peripherals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../peripherals/timers.html"><strong aria-hidden="true">4.1.</strong> Hardware Timers</a></li><li class="chapter-item expanded "><a href="../peripherals/interrupts.html"><strong aria-hidden="true">4.2.</strong> Interrupts and Machine States</a></li><li class="chapter-item expanded "><a href="../peripherals/state-machines.html"><strong aria-hidden="true">4.3.</strong> State Machines</a></li><li class="chapter-item expanded "><a href="../peripherals/led-array.html"><strong aria-hidden="true">4.4.</strong> The MB2 LED Array</a></li><li class="chapter-item expanded "><a href="../peripherals/adc.html"><strong aria-hidden="true">4.5.</strong> Analog-to-Digital Conversion (ADC)</a></li><li class="chapter-item expanded "><a href="../peripherals/pwm.html"><strong aria-hidden="true">4.6.</strong> Pulse Width Modulation (PWM)</a></li><li class="chapter-item expanded "><a href="../peripherals/i2c.html"><strong aria-hidden="true">4.7.</strong> I2C</a></li><li class="chapter-item expanded "><a href="../peripherals/spi.html"><strong aria-hidden="true">4.8.</strong> SPI</a></li></ol></li><li class="chapter-item expanded "><a href="../complexities/index.html"><strong aria-hidden="true">5.</strong> Hardware Complexities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../complexities/clocks.html"><strong aria-hidden="true">5.1.</strong> Clocks</a></li><li class="chapter-item expanded "><a href="../complexities/dma.html"><strong aria-hidden="true">5.2.</strong> Direct Memory Access (DMA)</a></li><li class="chapter-item expanded "><a href="../complexities/ppid.html"><strong aria-hidden="true">5.3.</strong> The NRF52 Programmable Peripheral Interface (PPI)</a></li><li class="chapter-item expanded "><a href="../complexities/nvram.html"><strong aria-hidden="true">5.4.</strong> Working With NVRAM</a></li></ol></li><li class="chapter-item expanded "><a href="../apis/index.html"><strong aria-hidden="true">6.</strong> Higher Level APIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apis/rtic.html"><strong aria-hidden="true">6.1.</strong> The RTIC Runtime</a></li><li class="chapter-item expanded "><a href="../apis/embassy.html"><strong aria-hidden="true">6.2.</strong> The Embassy Runtime</a></li><li class="chapter-item expanded "><a href="../apis/rtos.html"><strong aria-hidden="true">6.3.</strong> Real Time and Embedded Operating Systems</a></li></ol></li><li class="chapter-item expanded "><a href="../safety.html"><strong aria-hidden="true">7.</strong> Embedded Safety and Ethics</a></li><li class="chapter-item expanded "><a href="../onward.html"><strong aria-hidden="true">8.</strong> Moving Onward</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Embedded Rust Course Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="microbit-2-setup"><a class="header" href="#microbit-2-setup">MicroBit 2 Setup</a></h1>
<p>We are working with the BBC Micro::Bit v2 (MB2).
It is a fairly high-end embedded system.</p>
<p>The MB2 has 512KB flash, 128KB RAM, and runs at 64MHz (64
million instructions per second). It can run MicroPython,
although we will never speak of it here.  The peripheral set
includes some neat stuff. We will poke at many of the
peripherals.</p>
<p>The MB2's processor is the NRF52833. This is a 32-bit part
that runs the ARM instruction set. ARM machine instructions
are quite different from the x86 instructions your host
machine probably uses. The 32-bit ARM Instruction Set
Architecture (ISA) is called Cortex. The ISA has subsets for
smaller chips: M0, M3, M4, M7. The NRF52833 is a Cortex M4
part.</p>
<h2 id="setting-up-the-rust-toolchain"><a class="header" href="#setting-up-the-rust-toolchain">Setting Up The Rust Toolchain</a></h2>
<p>The MB2 doesn't have an OS. You can't just run code compiled
for your host on the MB2 because your host isn't a 32-bit
ARM (probably). You can't compile for the MB2 on the MB2:
it's too tiny and slow to run the compiler.</p>
<p>The solution is &quot;cross-compilation&quot;: compile programs to
ARM-32 on your host machine and then move them over.  For
many languages, cross-compilation isn't even possible.  For
C/C++ it is, but it is a serious pain.</p>
<p>For Rust, cross-compilation is a breeze. The standard tools
support it. You tell Cargo that you want to build an ARM-32
version of your code, and it just… does. You move it over
and run it.</p>
<p>You describe what you want the Rust toolchain to work with
by giving it a &quot;target&quot;, either as a command-line argument
or in configuration. You can say <code>rustup target list</code> to see
a list of all the targets available from Rust: currently
about 90 targets coering about 35 ISAs.</p>
<p>The MB2 wants the <code>thumbv7em-none-eabihf</code> target.</p>
<ul>
<li>
<p><code>thumbv7em</code> tells the toolchain to produce/use ARM
instructions suitable for (confusingly) both Cortex-M4 and
Cortex-M7 processors.  The Thumb instruction set is a
compacted form of the ISA for use when memory-limited: it
trades more decode logic for smaller program size.</p>
</li>
<li>
<p><code>none</code> means that there is no host operating system or
libraries on the target machine.</p>
</li>
<li>
<p><code>eabihf</code> is the Extended ABI (Application Binary
Interface) with Hardware Floating-point. Yes, we have an
FPU on this chip.</p>
</li>
</ul>
<h2 id="cargo-config-for-embedded"><a class="header" href="#cargo-config-for-embedded">Cargo Config For Embedded</a></h2>
<p>Rust is special in that it is <em>really</em> well set up for
cross-compilation to embedded targets.</p>
<p>The <a href="https://probe.rs/">probe-rs</a> project is set up to
enhance these capabilities further. <a href="https://ferrous-systems.com/">Ferrous
Systems</a> is a thing in this
space.</p>
<ul>
<li>Let's take a look at a sample Rust program and talk about
its Cargo config a little:
<a href="https://github.com/pdx-cs-rust-embedded/blinky-rs">https://github.com/pdx-cs-rust-embedded/blinky-rs</a></li>
</ul>
<h2 id="linkers-and-other-nightmares"><a class="header" href="#linkers-and-other-nightmares">Linkers and other nightmares</a></h2>
<ul>
<li>
<p>One thing the Rust tooling hides from us in part is
linking/loading. Once the compiler is done, all that
program code, initialized data, etc has to be set up in a
form that the MB2 bootloader can take.</p>
</li>
<li>
<p>Our tooling invokes <code>flip-link</code>, which is just a script
that invokes the host platform's ARM linker, or <code>rust-lld</code>
which is a link to the LLVM linker. These days most
linkers will work with many ABIs including ARM.</p>
</li>
<li>
<p>Everything expects ELF now. ELF is a format for object and
executable files. The program loading tool will read info
from the ARM executable and set the bootloader up to put
things in the right place.</p>
</li>
<li>
<p>&quot;The right place&quot; is pretty much per-board. Rust uses a file
<code>link.x</code> to figure that out: it lives in the <code>target</code>
directory until needed. Let's take a look…</p>
</li>
</ul>
<h2 id="bootloading-and-debugging"><a class="header" href="#bootloading-and-debugging">Bootloading and debugging</a></h2>
<ul>
<li>
<p>There's a little bit of bootloading in ROM on a separate
nRF52820. Essentially, there's some support for on-chip
debugging, and this includes something that can take
a binary by USB and put things where it's told.</p>
</li>
<li>
<p>The specific protocol here is
<a href="https://developer.arm.com/documentation/101451/0100/About-CMSIS-DAP">CMSIS-DAP</a>. Mostly don't ask.</p>
</li>
<li>
<p>For Rust, the <code>probe-run</code> command should be installed, and
sets this all up. The <code>cargo-embed</code> utility is also
involved often.</p>
</li>
<li>
<p>A more generic solution is provided by
<a href="https://openocd.org/">OpenOCD</a>. For other boards, and
other languages, this is an invaluable tool. We likely
won't use it here.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../starting/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../starting/rust-review.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../starting/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../starting/rust-review.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
